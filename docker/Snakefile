#########################################
# mtDNA-GSDME Immune Tolerance Pipeline
# Snakemake Workflow
# Automatically generated
#########################################

import os
from pathlib import Path

configfile: "config/paths_example.yaml"

BASE = Path(config["base_dir"])
RAW = BASE / config["raw_data_dir"]
PROC = BASE / config["processed_data_dir"]
RES = BASE / "results"


#########################################
# Global settings
#########################################

shell.executable("/bin/bash")
logdir = "results/logs"
os.makedirs(logdir, exist_ok=True)


#########################################
# Rule: all
# (Final targets)
#########################################

rule all:
    input:
        RES / "mtLeakScore/mtLeakScore.tsv",
        RES / "nonCanonicalPyro/nonCanonicalPyroScore.tsv",
        RES / "spatial_deconvolution/output.rds",
        RES / "reports/A_quicklook_results.html"


#########################################
# 00 — Environment check
#########################################

rule check_environment:
    output:
        touch("results/flags/00_check_environment.done")
    log:
        "results/logs/00_check_environment.log"
    shell:
        """
        python scripts/00_check_environment.py --config {configfile} \
        > {log} 2>&1
        """


#########################################
# 01 — Download datasets
#########################################

rule download_data:
    input:
        "results/flags/00_check_environment.done"
    output:
        touch("results/flags/01_download_data.done")
    log:
        "results/logs/01_download_data.log"
    shell:
        """
        python scripts/01_download_data.py --config {configfile} \
        > {log} 2>&1
        """


#########################################
# 02 — Preprocess spatial data
#########################################

rule preprocess_spatial:
    input:
        "results/flags/01_download_data.done"
    output:
        PROC / "spatial_preprocessed.h5ad"
    log:
        "results/logs/02_preprocess_spatial.log"
    shell:
        """
        python scripts/02_preprocess_spatial.py --config {configfile} \
        --output {output} \
        > {log} 2>&1
        """


#########################################
# 03 — Preprocess scRNA-seq
#########################################

rule preprocess_scrna:
    input:
        PROC / "spatial_preprocessed.h5ad"
    output:
        PROC / "scRNA_preprocessed.h5ad"
    log:
        "results/logs/03_preprocess_scRNA.log"
    shell:
        """
        python scripts/03_preprocess_scRNA.py --config {configfile} \
        --input {input} --output {output} \
        > {log} 2>&1
        """


#########################################
# 10 — mtLeakScore
#########################################

rule mtLeakScore:
    input:
        PROC / "scRNA_preprocessed.h5ad"
    output:
        RES / "mtLeakScore/mtLeakScore.tsv"
    log:
        "results/logs/10_mtLeakScore.log"
    shell:
        """
        python scripts/10_compute_mtLeakScore.py --config {configfile} \
        > {log} 2>&1
        """


#########################################
# 11 — nonCanonicalPyroScore
#########################################

rule nonCanonicalPyroScore:
    input:
        PROC / "scRNA_preprocessed.h5ad"
    output:
        RES / "nonCanonicalPyro/nonCanonicalPyroScore.tsv"
    log:
        "results/logs/11_nonCanonicalPyro.log"
    shell:
        """
        python scripts/11_compute_nonCanonicalPyroScore.py --config {configfile} \
        > {log} 2>&1
        """


#########################################
# 20 — Spatial Deconvolution (R)
#########################################

rule spatial_deconvolution:
    input:
        PROC / "spatial_preprocessed.h5ad",
        PROC / "scRNA_preprocessed.h5ad"
    output:
        RES / "spatial_deconvolution/output.rds"
    log:
        "results/logs/20_spatial_deconvolution.log"
    shell:
        """
        Rscript scripts/20_spatial_deconvolution.R {configfile} \
        > {log} 2>&1
        """


#########################################
# Notebooks → HTML report
#########################################

rule final_report:
    input:
        RES / "spatial_deconvolution/output.rds"
    output:
        RES / "reports/A_quicklook_results.html"
    log:
        "results/logs/99_report.log"
    shell:
        """
        jupyter nbconvert --to html notebooks/A_quicklook_results.ipynb \
        --output {output} \
        > {log} 2>&1
        """


#########################################
# END
#########################################
