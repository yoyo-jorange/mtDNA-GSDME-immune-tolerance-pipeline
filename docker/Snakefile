#########################################
# mtDNA-GSDME Immune Tolerance Pipeline
# Snakemake Workflow — 完全适配 Docker + /workspace
#########################################
import os
from pathlib import Path

# ========== 关键修改 1：固定 config 路径（容器内绝对路径）==========
configfile: "/workspace/config/paths.yaml"   # ← 改这里！不要用相对路径

# ========== 关键修改 2：路径定义（使用你之前 paths.yaml 的键名）==========
BASE = Path("/workspace")                                      # 固定根目录
RAW  = BASE / config["data_raw"]                               # ← 对应 paths.yaml 的 data_raw
PROC = BASE / config["data_processed"]                         # ← 对应 data_processed
RES  = BASE / config["results"]                                # ← 对应 results

# ========== 关键修改 3：日志目录统一 + 自动创建 ==========
LOGDIR = RES / "logs"
os.makedirs(LOGDIR, exist_ok=True)
os.makedirs(RES / "flags", exist_ok=True)   # 为 flag 文件夹也创建

shell.executable("/bin/bash")

#########################################
# Rule: all
#########################################
rule all:
    input:
        RES / "mtLeakScore/mtLeakScore.tsv",
        RES / "nonCanonicalPyro/nonCanonicalPyroScore.tsv",
        RES / "spatial_deconvolution/output.rds",
        RES / "reports/A_quicklook_results.html"

#########################################
# 00 — Environment check
#########################################
rule check_environment:
    output:
        touch(RES / "flags/00_check_environment.done")
    log:
        LOGDIR / "00_check_environment.log"
    shell:
        """
        python /workspace/scripts/00_check_environment.py --config {configfile} \
        > {log} 2>&1
        """

#########################################
# 01 — Download datasets
#########################################
rule download_data:
    input:
        RES / "flags/00_check_environment.done"
    output:
        touch(RES / "flags/01_download_data.done")
    log:
        LOGDIR / "01_download_data.log"
    shell:
        """
        python /workspace/scripts/01_download_data.py --config {configfile} \
        > {log} 2>&1
        """

#########################################
# 02 — Preprocess spatial data
#########################################
rule preprocess_spatial:
    input:
        RES / "flags/01_download_data.done"
    output:
