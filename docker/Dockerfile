# ä½¿ç”¨æœ€æ–°çš„ Rocker é•œåƒä½œä¸ºåŸºç¡€ï¼Œæ”¯æŒ R 4.4+ å’Œ Python 3.11+
FROM rocker/tidyverse:4.4.1

# è®¾ç½®éäº¤äº’å¼å®‰è£…ï¼Œé¿å…å¡ä½
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    libssl-dev \
    libcurl4-openssl-dev \
    libxml2-dev \
    libfontconfig1-dev \
    libharfbuzz-dev \
    libfribidi-dev \
    libfreetype6-dev \
    libpng-dev \
    libtiff5-dev \
    libjpeg-dev \
    ghostscript \
    texlive-latex-recommended \
    texlive-fonts-recommended \
    texinfo \
    lmodern \
    default-jdk \
    python3-dev \
    python3-pip \
    curl \
    wget \
    git \
    nano \
    htop \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½® Python åˆ«å
RUN ln -sf /usr/bin/python3 /usr/bin/python

# å®‰è£…æ ¸å¿ƒ Python åŒ…ï¼ˆå•ç»†èƒ + ç©ºé—´ç»„å­¦ + å› æœæ¨æ–­ï¼‰
RUN pip3 install --no-cache-dir --upgrade pip && \
    pip3 install --no-cache-dir \
    numpy==1.26.4 \
    pandas==2.2.2 \
    scipy==1.13.1 \
    scikit-learn==1.5.1 \
    matplotlib==3.9.2 \
    seaborn==0.13.2 \
    plotly==5.22.0 \
    scanpy==1.10.2 \
    anndata==0.11.3 \
    squidpy==1.5.0 \
    harmonypy==0.0.10 \
    gseapy==1.1.3 \
    lifelines==0.27.8 \
    statsmodels==0.14.2 \
    jupyterlab==4.2.5 \
    nbconvert==7.16.3 \
    # å› æœæ¨æ–­
    dowhy==0.11.1 \
    causalml==0.15.0 \
    econml==0.15.1 \
    # ğŸ”¥ GDC APIç›´æ¥è®¿é—®ï¼ˆæ›¿æ¢gdc-clientï¼‰
    requests==2.32.3 \
    beautifulsoup4==4.12.3 \
    lxml==5.3.0 \
    # TCGA/GEO ä¸‹è½½
    GEOparse==1.4.0 \
    # ç©ºé—´è§£å·ç§¯ Python æ¥å£
    tangram-py==0.2.0 \
    && pip3 cache purge

# å®‰è£…æ ¸å¿ƒ R åŒ…ï¼ˆSeurat + ç©ºé—´è§£å·ç§¯ + GSVAï¼‰
RUN R -e "options(repos = c(CRAN = 'https://cloud.r-project.org')); \
    install.packages(c('remotes', 'BiocManager', 'devtools'), ask = FALSE)" && \
    R -e "BiocManager::install(c('SingleCellExperiment', 'SingleR', 'scater', \
                               'scran', 'batchelor', 'DoubletFinder'), \
                               ask = FALSE, update = FALSE)" && \
    R -e "install.packages(c('Seurat', 'SeuratObject', 'SeuratDisk', \
                            'ggplot2', 'ggpubr', 'patchwork', 'harmony', \
                            'DoubletFinder', 'celldex', 'scDblFinder', \
                            'data.table', 'Matrix', 'reticulate', 'future', \
                            'future.apply'), repos = 'https://cloud.r-project.org', \
                            dependencies = TRUE)" && \
    # ç©ºé—´è§£å·ç§¯å››é‡éªŒè¯
    R -e "remotes::install_github(c('bayesLab/Cell2location@v2.0.3', \
                                   'lzheimer/Giotto@3.1.0', \
                                   'dmcable/spatialDWLS', \
                                   'dmcable/RCTD'), \
                                   dependencies = TRUE, upgrade = FALSE)" && \
    # GSVA å’ŒåŸºå› é›†åˆ†æ
    R -e "BiocManager::install(c('GSVA', 'clusterProfiler', 'enrichplot', \
                                'org.Hs.eg.db'), ask = FALSE)" && \
    # å› æœæ¨æ–­ R æ¥å£
    R -e "install.packages(c('doWhy', 'CausalML'), repos = 'https://cloud.r-project.org')"

# éªŒè¯å…³é”®åŒ…å®‰è£…
RUN R -e "library(Seurat); library(Cell2location); library(tangram); cat('Seurat:', packageVersion('Seurat'), '\n')" && \
    python3 -c "import scanpy, anndata, dowhy, causalml; print('Scanpy:', scanpy.__version__)"

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /workspace

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY . /workspace

# é»˜è®¤å‘½ä»¤
CMD ["/bin/bash"]
