import pandas as pd
import numpy as np
from pathlib import Path
import yaml
import gdc_client as gdc

def download_tcga(config):
    """下载TCGA pan-cancer数据"""
    client = gdc.GDCAPI()
    files = client.get_results("cases", 
                              filters={"op": "in", "content": [{"field": "files.data_category", "value": ["Transcriptome Profiling"]}]},
                              fields="file_id,file_name,cases.project.project_id")
    
    raw_dir = Path(config["data_raw"]) / "tcga"
    raw_dir.mkdir(exist_ok=True)
    
    for file in files[:100]:  # 先下载100个测试
        print(f"下载TCGA: {file['file_name']}")
        # gdc下载逻辑...

def process_cfdna(geo_ids=["GSE211732", "GSE236263"]):
    """处理cfDNA甲基化数据"""
    proc_dir = Path("data_processed/cfdna")
    proc_dir.mkdir(exist_ok=True)
    
    for geo_id in geo_ids:
        # GEOparse下载并处理
        gse = GEOparse.get_GEO(geo_id=geo_id)
        expr_matrix = gse.gsms[0].table
        expr_matrix.to_csv(proc_dir / f"{geo_id}_matrix.csv")

def main():
    with open("config/paths.yaml") as f:
        config = yaml.safe_load(f)
    
    download_tcga(config)
    process_cfdna()
    print("✅ TCGA + cfDNA预处理完成")

if __name__ == "__main__":
    main()
