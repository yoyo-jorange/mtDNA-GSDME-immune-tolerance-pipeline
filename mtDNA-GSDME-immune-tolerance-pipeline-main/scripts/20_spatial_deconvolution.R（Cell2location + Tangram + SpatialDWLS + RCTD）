#!/usr/bin/env Rscript
library(Seurat)
library(Cell2location)
library(tangram)
library(spatialDWLS)
library(spacexr)
library(future)

# å¹¶è¡Œè®¾ç½®
plan("multisession", workers = 4)

# åŠ è½½é…ç½®å’Œæ•°æ®
config <- yaml::read_yaml("config/paths.yaml")
spatial_dir <- file.path(config$data_processed, "spatial")
scrna_dir <- file.path(config$data_processed, "scrna")
deconv_dir <- file.path(config$data_processed, "deconvolution")
dir.create(deconv_dir, recursive = TRUE)

# å››é‡è§£å·ç§¯ä¸»å‡½æ•°
four_way_deconv <- function(spatial_sample, scrna_ref) {
  cat("å››é‡è§£å·ç§¯:", spatial_sample, "\n")
  
  # 1. åŠ è½½æ•°æ®
  spatial <- readRDS(file.path(spatial_dir, paste0(spatial_sample, "_processed.rds")))
  ref <- readRDS(file.path(scrna_dir, paste0(scrna_ref, "_ref.rds")))
  
  # 2. Cell2location
  cell2loc_res <- run_cell2location(spatial@assays$RNA@counts, ref)
  
  # 3. Tangram
  tangram_res <- tangram::map_cells_to_space(ref, spatial)
  
  # 4. SpatialDWLS  
  dwls_res <- spatialDWLS::spatialDWLS(spatial, ref)
  
  # 5. RCTD
  rctd_res <- run.RCTD(spatial, ref)
  
  # 6. å…±è¯†ç»“æœï¼ˆä¸­ä½æ•°ï¼‰
  cell_types <- config$cell_types
  consensus <- data.frame(
    spot = colnames(spatial),
    cell2loc = cell2loc_res[cell_types],
    tangram = tangram_res[cell_types],
    dwls = dwls_res[cell_types],
    rctd = rctd_res[cell_types],
    consensus = rowMeans(cbind(cell2loc_res, tangram_res, dwls_res, rctd_res))
  )
  
  # ä¿å­˜
  saveRDS(consensus, file.path(deconv_dir, paste0(spatial_sample, "_deconv.rds")))
  write.csv(consensus, file.path("results/tables", paste0(spatial_sample, "_deconv.csv")))
  
  cat("âœ… å®Œæˆ:", spatial_sample, "\n")
}

# æ‰¹é‡å¤„ç†
samples <- list.files(spatial_dir, pattern = "*.rds")
sapply(samples, four_way_deconv, scrna_ref = "GSE211732_ref")

cat("ğŸ‰ å››é‡ç©ºé—´è§£å·ç§¯å®Œæˆï¼\n")
